# Fastfile for Sara

default_platform(:ios)

platform :ios do
  # Helper method to generate release notes from git commits
  # Parameters: environment - "dev", "stage", or "prod"
  def generate_release_notes(environment)
    begin
      # Get all tags sorted by creation date
      all_tags = sh("git tag --sort=-creatordate 2>/dev/null || echo ''").strip.split("\n")

      # Filter tags based on environment
      latest_tag = ""
      all_tags.each do |tag|
        next if tag.empty?

        if environment == "dev" && tag.include?("-dev")
          latest_tag = tag
          break
        elsif environment == "stage" && tag.include?("-stage")
          latest_tag = tag
          break
        elsif environment == "prod" && !tag.include?("-dev") && !tag.include?("-stage")
          latest_tag = tag
          break
        end
      end

      # Determine commit range
      if latest_tag.empty?
        commit_range = "HEAD"
        tag_info = "All commits"
        UI.message("No tags found for #{environment}. Using all commits.")
      else
        commit_range = "#{latest_tag}..HEAD"
        tag_info = "Changes since #{latest_tag}"
        UI.message("Latest tag for #{environment}: #{latest_tag}")
      end

      # Count commits
      commit_count = sh("git rev-list --count #{commit_range} 2>/dev/null || echo '0'").strip.to_i

      if commit_count == 0
        UI.message("No new commits since last tag.")
        return "No new changes since last release."
      end

      UI.message("Found #{commit_count} commits since last tag")

      # Get version from package.json
      package_json_path = File.join(Dir.pwd, "..", "..", "package.json")
      version = "Unknown"
      if File.exist?(package_json_path)
        package_json = File.read(package_json_path)
        version_match = package_json.match(/"version":\s*"([^"]+)"/)
        version = version_match[1] if version_match
      end

      # Get commit messages
      commits = sh("git log #{commit_range} --pretty=format:'- %s' --reverse").strip

      # Generate release notes
      release_notes = <<~NOTES
        Version: #{version}
        Date: #{Time.now.strftime('%Y-%m-%d %H:%M')}
        #{tag_info}

        What's New:
        #{commits}

        Total commits: #{commit_count}

        Generated with Sara Release Notes Generator
      NOTES

      # Write to file
      release_notes_path = File.join(Dir.pwd, "release-notes.txt")
      File.write(release_notes_path, release_notes)

      UI.success("✅ Release notes generated successfully!")
      return release_notes

    rescue => ex
      UI.warning("⚠️  Could not generate release notes automatically: #{ex.message}")
      # Fallback to default message
      fallback_notes = "New build uploaded via Fastlane\n\nGenerated: #{Time.now.strftime('%Y-%m-%d %H:%M')}"

      # Write fallback notes to file
      release_notes_path = File.join(Dir.pwd, "release-notes.txt")
      File.write(release_notes_path, fallback_notes)

      return fallback_notes
    end
  end

  desc "Build and distribute Dev version to Firebase App Distribution"
  lane :dev do
    firebase_app_id_dev = "1:368956526793:ios:3abacbefefab06bfaf7d18"

    # Increment build number
    increment_build_number(xcodeproj: "Sara.xcodeproj")

    # Increment patch version (1.0.0 -> 1.0.1)
    increment_version_number(
      xcodeproj: "Sara.xcodeproj",
      bump_type: "patch"
    )

    # Generate release notes
    release_notes = generate_release_notes("dev")

    # Archive the app (skip IPA packaging)
    gym(
      workspace: "Sara.xcworkspace",
      scheme: "SaraDev",
      configuration: "Release",
      skip_package_ipa: true,
      skip_archive: false,
      xcargs: "-allowProvisioningUpdates"
    )

    # Get the archive path
    archive_path = lane_context[SharedValues::XCODEBUILD_ARCHIVE]

    # Manually create IPA from archive
    output_path = File.join(Dir.pwd, "build")
    FileUtils.mkdir_p(output_path)

    ipa_path = File.join(output_path, "Sara-Dev.ipa")

    # Create Payload directory
    payload_dir = File.join(output_path, "Payload")
    FileUtils.rm_rf(payload_dir) if File.exist?(payload_dir)
    FileUtils.mkdir_p(payload_dir)

    # Copy .app to Payload directory
    app_path = File.join(archive_path, "Products", "Applications", "Sara Dev.app")
    FileUtils.cp_r(app_path, payload_dir)

    # Create IPA (which is just a zip file)
    Dir.chdir(output_path) do
      sh("zip -r Sara-Dev.ipa Payload")
    end

    # Clean up Payload directory
    FileUtils.rm_rf(payload_dir)

    UI.success("✅ Successfully created IPA at: #{ipa_path}")

    firebase_app_distribution(
      app: firebase_app_id_dev,
      ipa_path: ipa_path,
      groups: "wemotive",
      release_notes: release_notes
    )
  end

  desc "Build and distribute Stage version to Firebase App Distribution"
  lane :stage do
    firebase_app_id_stage = "1:368956526793:ios:5760568fa7a51bbcaf7d18"

    # Increment build number
    increment_build_number(xcodeproj: "Sara.xcodeproj")

    # Increment patch version (1.0.0 -> 1.0.1)
    increment_version_number(
      xcodeproj: "Sara.xcodeproj",
      bump_type: "patch"
    )

    # Generate release notes
    release_notes = generate_release_notes("stage")

    # Archive the app (skip IPA packaging)
    gym(
      workspace: "Sara.xcworkspace",
      scheme: "SaraStage",
      configuration: "Release",
      skip_package_ipa: true,
      skip_archive: false,
      xcargs: "-allowProvisioningUpdates"
    )

    # Get the archive path
    archive_path = lane_context[SharedValues::XCODEBUILD_ARCHIVE]

    # Manually create IPA from archive
    output_path = File.join(Dir.pwd, "build")
    FileUtils.mkdir_p(output_path)

    ipa_path = File.join(output_path, "Sara-Stage.ipa")

    # Create Payload directory
    payload_dir = File.join(output_path, "Payload")
    FileUtils.rm_rf(payload_dir) if File.exist?(payload_dir)
    FileUtils.mkdir_p(payload_dir)

    # Copy .app to Payload directory
    app_path = File.join(archive_path, "Products", "Applications", "Sara Stage.app")
    FileUtils.cp_r(app_path, payload_dir)

    # Create IPA (which is just a zip file)
    Dir.chdir(output_path) do
      sh("zip -r Sara-Stage.ipa Payload")
    end

    # Clean up Payload directory
    FileUtils.rm_rf(payload_dir)

    UI.success("✅ Successfully created IPA at: #{ipa_path}")

    firebase_app_distribution(
      app: firebase_app_id_stage,
      ipa_path: ipa_path,
      groups: "wemotive",
      release_notes: release_notes
    )
  end

  desc "Build and distribute Prod version to Firebase App Distribution"
  lane :prod do
    firebase_app_id_prod = "1:368956526793:ios:1901b22d67210283af7d18"

    # Increment build number
    increment_build_number(xcodeproj: "Sara.xcodeproj")

    # Increment patch version (1.0.0 -> 1.0.1)
    increment_version_number(
      xcodeproj: "Sara.xcodeproj",
      bump_type: "patch"
    )

    # Generate release notes
    release_notes = generate_release_notes("prod")

    # Archive the app (skip IPA packaging)
    gym(
      workspace: "Sara.xcworkspace",
      scheme: "Sara",
      configuration: "Release",
      skip_package_ipa: true,
      skip_archive: false,
      xcargs: "-allowProvisioningUpdates"
    )

    # Get the archive path
    archive_path = lane_context[SharedValues::XCODEBUILD_ARCHIVE]

    # Manually create IPA from archive
    output_path = File.join(Dir.pwd, "build")
    FileUtils.mkdir_p(output_path)

    ipa_path = File.join(output_path, "Sara-Prod.ipa")

    # Create Payload directory
    payload_dir = File.join(output_path, "Payload")
    FileUtils.rm_rf(payload_dir) if File.exist?(payload_dir)
    FileUtils.mkdir_p(payload_dir)

    # Copy .app to Payload directory
    app_path = File.join(archive_path, "Products", "Applications", "Sara.app")
    FileUtils.cp_r(app_path, payload_dir)

    # Create IPA (which is just a zip file)
    Dir.chdir(output_path) do
      sh("zip -r Sara-Prod.ipa Payload")
    end

    # Clean up Payload directory
    FileUtils.rm_rf(payload_dir)

    UI.success("✅ Successfully created IPA at: #{ipa_path}")

    firebase_app_distribution(
      app: firebase_app_id_prod,
      ipa_path: ipa_path,
      groups: "wemotive",
      release_notes: release_notes
    )
  end
end
